name: Build 3proxy for MT7621 (MIPS)

on:
  workflow_dispatch:
  push:
    branches: [ master ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        repository: z3APA3A/3proxy
        ref: master

    - name: Install Cross-Compiler (mipsel)
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc-mipsel-linux-gnu build-essential

    - name: Compile 3proxy (Main Binary Only)
      run: |
        # 1. 手动生成 src 目录下所需的 Makefile.var
        # 这是之前报错缺失文件步骤的补救措施
        cp Makefile.Linux src/Makefile.var
        
        # 2. 仅编译 src 目录 (跳过 plugins 防止动态链接错误)
        # 注意：这里继续强制使用 -static 静态编译
        make -C src \
             CC=mipsel-linux-gnu-gcc \
             LD=mipsel-linux-gnu-gcc \
             CFLAGS="-g -O2 -fno-strict-aliasing -c -pthread -D_THREAD_SAFE -D_REENTRANT -DNOODBC -DWITH_STD_MALLOC -DFD_SETSIZE=4096 -DWITH_POLL -static" \
             LDFLAGS="-g -O2 -fno-strict-aliasing -pthread -static"

    - name: Check binary architecture
      run: |
        # 验证文件架构是否为 MIPS
        ls -l src/
        file src/3proxy

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: 3proxy-mt7621-mipsel-static
        path: |
          src/3proxy
          scripts/3proxy.cfg
