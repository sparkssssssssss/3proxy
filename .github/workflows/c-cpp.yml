name: Build 3proxy for MT7621 (MIPS)

on:
  workflow_dispatch:
  push:
    branches: [ master ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        repository: z3APA3A/3proxy
        ref: master

    - name: Install Cross-Compiler (mipsel)
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc-mipsel-linux-gnu build-essential

    - name: Compile 3proxy (Force Static & No Plugins)
      run: |
        # 1. 修复 "Makefile.var: No such file" 错误
        # 官方脚本本该做这一步，我们手动帮它做
        cp Makefile.Linux src/Makefile.var

        # 2. 【核心修复】修改 src/Makefile，暴力移除插件编译
        # 使用 sed 删除 'plugins' 依赖，确保编译器根本不看 plugins 目录
        # 这样就能完美避开 relocation R_MIPS_HI16 错误
        sed -i 's/ plugins//g' src/Makefile
        sed -i 's/^SUBDIRS = plugins/SUBDIRS =/g' src/Makefile

        # 3. 开始编译
        # 只编译 src 目录
        make -C src \
             CC=mipsel-linux-gnu-gcc \
             LD=mipsel-linux-gnu-gcc \
             CFLAGS="-g -O2 -fno-strict-aliasing -c -pthread -D_THREAD_SAFE -D_REENTRANT -DNOODBC -DWITH_STD_MALLOC -DFD_SETSIZE=4096 -DWITH_POLL -static" \
             LDFLAGS="-g -O2 -fno-strict-aliasing -pthread -static"

    - name: Check binary architecture
      run: |
        # 确认编译结果
        ls -lh src/3proxy
        # 确认它是 MIPS 架构且是静态链接 (statically linked)
        file src/3proxy

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: 3proxy-mt7621-mipsel-static
        path: |
          src/3proxy
          scripts/3proxy.cfg
