name: Build 3proxy for MT7621 (MIPS)

on:
  workflow_dispatch:
  push:
    branches: [ master ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        repository: z3APA3A/3proxy
        ref: master

    - name: Install Cross-Compiler (mipsel)
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc-mipsel-linux-gnu build-essential

    - name: Compile 3proxy (Main Binary Only)
      run: |
        ln -s Makefile.Linux Makefile
        
        # 关键修改：
        # 1. 使用 make -C src 只编译源代码目录，跳过 plugins 目录
        # 2. 保持 -static 以确保在路由器上能运行
        make -C src \
             CC=mipsel-linux-gnu-gcc \
             LD=mipsel-linux-gnu-gcc \
             CFLAGS="-g -O2 -fno-strict-aliasing -c -pthread -D_THREAD_SAFE -D_REENTRANT -DNOODBC -DWITH_STD_MALLOC -DFD_SETSIZE=4096 -DWITH_POLL -static" \
             LDFLAGS="-g -O2 -fno-strict-aliasing -pthread -static"

    - name: Check binary architecture
      run: |
        # 验证文件
        ls -l src/
        file src/3proxy

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: 3proxy-mt7621-mipsel-static
        path: |
          src/3proxy
          scripts/3proxy.cfg
