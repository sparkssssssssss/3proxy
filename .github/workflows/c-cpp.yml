name: Build 3proxy static lite (MT7621)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4

      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y wget xz-utils git file

      - name: Set vars (pin stable versions)
        run: |
          echo "TPROXY_VER=0.9.4" >> $GITHUB_ENV
          echo "TC_URL_1=https://more.musl.cc/11.2.1/x86_64-linux-musl/mipsel-linux-musl-cross.tgz" >> $GITHUB_ENV
          echo "TC_URL_2=https://musl.cc/mipsel-linux-musl-cross.tgz" >> $GITHUB_ENV

      - name: Download toolchain (with fallback)
        run: |
          set -eux
          wget -O tc.tgz "$TC_URL_1" || wget -O tc.tgz "$TC_URL_2"
          tar -xzf tc.tgz
          mv mipsel-linux-musl-cross toolchain

      - name: Download 3proxy source
        run: |
          set -eux
          git clone --depth=1 --branch "$TPROXY_VER" https://github.com/3proxy/3proxy.git 3proxy-src

      - name: Build static (size-first)
        working-directory: 3proxy-src
        run: |
          set -eux
          export PATH="$GITHUB_WORKSPACE/toolchain/bin:$PATH"
          export CC=mipsel-linux-musl-gcc
          export AR=mipsel-linux-musl-ar
          export RANLIB=mipsel-linux-musl-ranlib
          export STRIP=mipsel-linux-musl-strip

          make -f Makefile.Linux clean || true
          make -f Makefile.Linux \
            CC="$CC" AR="$AR" RANLIB="$RANLIB" STRIP="$STRIP" \
            CFLAGS="-Os -fdata-sections -ffunction-sections -static" \
            LDFLAGS="-static -Wl,--gc-sections -s"

          test -f bin/3proxy
          $STRIP --strip-all bin/3proxy
          file bin/3proxy

      - name: Pack
        run: |
          mkdir -p out
          cp 3proxy-src/bin/3proxy out/3proxy-mt7621-static-lite
          tar -C out -czf 3proxy-mt7621-static-lite.tar.gz 3proxy-mt7621-static-lite

      - uses: actions/upload-artifact@v4
        with:
          name: 3proxy-mt7621-static-lite
          path: |
            out/3proxy-mt7621-static-lite
            3proxy-mt7621-static-lite.tar.gz
