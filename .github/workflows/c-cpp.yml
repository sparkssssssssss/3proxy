name: Build 3proxy static lite (MT7621, no musl.cc)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 40

    steps:
      - uses: actions/checkout@v4

      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y wget xz-utils git file ca-certificates

      - name: Set vars
        run: |
          echo "TPROXY_VER=0.9.4" >> $GITHUB_ENV
          echo "OWRT_VER=23.05.5" >> $GITHUB_ENV
          echo "SDK_FILE=openwrt-sdk-23.05.5-ramips-mt7621_gcc-12.3.0_musl.Linux-x86_64.tar.xz" >> $GITHUB_ENV
          echo "SDK_URL_1=https://downloads.openwrt.org/releases/23.05.5/targets/ramips/mt7621/openwrt-sdk-23.05.5-ramips-mt7621_gcc-12.3.0_musl.Linux-x86_64.tar.xz" >> $GITHUB_ENV
          # 你可以再加自己的备用URL（比如你自己的 GitHub Release）
          echo "SDK_URL_2=" >> $GITHUB_ENV

      - name: Download OpenWrt SDK (IPv4 + retry)
        run: |
          set -eux
          wget -4 --tries=3 --timeout=30 -O sdk.tar.xz "$SDK_URL_1" || \
          wget -4 --tries=3 --timeout=30 -O sdk.tar.xz "$SDK_URL_2"
          tar -xf sdk.tar.xz
          mv openwrt-sdk-* openwrt-sdk

      - name: Download 3proxy
        run: |
          set -eux
          git clone --depth=1 --branch "$TPROXY_VER" https://github.com/3proxy/3proxy.git 3proxy-src

      - name: Build static (size-first)
        working-directory: 3proxy-src
        run: |
          set -eux
          TOOLCHAIN_DIR=$(echo "$GITHUB_WORKSPACE"/openwrt-sdk/staging_dir/toolchain-*)
          GCC=$(ls "$TOOLCHAIN_DIR"/bin/*-openwrt-linux-musl-gcc | head -n1)
          CROSS_PREFIX="${GCC%gcc}"

          export CC="${CROSS_PREFIX}gcc"
          export AR="${CROSS_PREFIX}ar"
          export RANLIB="${CROSS_PREFIX}ranlib"
          export STRIP="${CROSS_PREFIX}strip"

          make -f Makefile.Linux clean || true
          make -f Makefile.Linux \
            CC="$CC" AR="$AR" RANLIB="$RANLIB" STRIP="$STRIP" \
            CFLAGS="-Os -static -fno-stack-protector -U_FORTIFY_SOURCE -ffunction-sections -fdata-sections" \
            LDFLAGS="-static -Wl,--gc-sections"

          test -f bin/3proxy
          $STRIP --strip-all bin/3proxy
          file bin/3proxy

      - name: Pack
        run: |
          mkdir -p out
          cp 3proxy-src/bin/3proxy out/3proxy-mt7621-static-lite
          tar -C out -czf 3proxy-mt7621-static-lite.tar.gz 3proxy-mt7621-static-lite

      - uses: actions/upload-artifact@v4
        with:
          name: 3proxy-mt7621-static-lite
          path: |
            out/3proxy-mt7621-static-lite
            3proxy-mt7621-static-lite.tar.gz
