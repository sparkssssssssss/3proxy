name: Cross Compile 3proxy (High Performance)

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - '.github/workflows/build-3proxy.yml'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout 3proxy source
        uses: actions/checkout@v4
        with:
          repository: z3APA3A/3proxy
          ref: master
          
      - name: Install Cross-Compiler
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-mipsel-linux-gnu make
          
      - name: Compile 3proxy (Optimized for MT7621)
        run: |
          # 性能优化参数解释：
          # -O2: 工业级标准优化，比 -O3 更稳定，适合网络服务
          # -mips32r2: MT7621 支持 MIPS32 Release 2 指令集，开启后效率更高
          # -mtune=mips32r2: 专门针对此架构微调
          # -fomit-frame-pointer: 释放寄存器用于通用用途，略微提升性能
          # -static: 静态链接，确保兼容性（虽然增加体积，但避免动态库加载开销）
          
          make -f Makefile.Linux \
          CC=mipsel-linux-gnu-gcc \
          LN="mipsel-linux-gnu-gcc -static" \
          CFLAGS="-g0 -O2 -mips32r2 -mtune=mips32r2 -fomit-frame-pointer -fno-strict-aliasing -c -pthread -D_THREAD_SAFE -D_REENTRANT -DNOODBC -DWITH_STD_MALLOC -D_GNU_SOURCE" \
          LDFLAGS="-static -s"

      - name: Check Binary Info
        run: |
          # 验证文件架构
          file src/3proxy
          # 打印文件大小（虽然没压缩，但 C 语言写的一般也就 1MB 左右）
          du -h src/3proxy

      - name: Rename Output
        run: |
          mv src/3proxy 3proxy_mt7621_perf

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: 3proxy-mt7621-perf
          path: 3proxy_mt7621_perf
