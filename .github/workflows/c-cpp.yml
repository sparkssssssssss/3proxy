name: Build 3proxy for MT7621 (MIPS)

on:
  workflow_dispatch:
  push:
    branches: [ master ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        repository: z3APA3A/3proxy
        ref: master

    - name: Install Cross-Compiler (mipsel)
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc-mipsel-linux-gnu build-essential

    - name: Compile 3proxy (Nuclear Option)
      run: |
        # 1. 初始化变量文件 (必须步骤)
        cp Makefile.Linux src/Makefile.var

        # 2. 【核弹级修复】
        # 直接删除 src/Makefile 中所有以 SUBDIRS 开头的行
        # 无论它是 "SUBDIRS = plugins" 还是 "SUBDIRS=plugins" (带tab或空格)，统统删掉
        sed -i '/^SUBDIRS/d' src/Makefile

        # 3. 编译
        # -C src: 进入 src 目录
        # SUBDIRS="": 再次强制置空子目录变量，双重保险
        # 3proxy: 显式告诉 make 只编译 "3proxy" 这个二进制文件，不要编译 "all"
        make -C src 3proxy \
             SUBDIRS="" \
             CC=mipsel-linux-gnu-gcc \
             LD=mipsel-linux-gnu-gcc \
             CFLAGS="-g -O2 -fno-strict-aliasing -c -pthread -D_THREAD_SAFE -D_REENTRANT -DNOODBC -DWITH_STD_MALLOC -DFD_SETSIZE=4096 -DWITH_POLL -static" \
             LDFLAGS="-g -O2 -fno-strict-aliasing -pthread -static"

    - name: Check binary architecture
      run: |
        # 检查是否成功生成
        ls -lh src/3proxy
        # 验证架构和静态链接属性
        file src/3proxy

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: 3proxy-mt7621-mipsel-static
        path: |
          src/3proxy
          scripts/3proxy.cfg
