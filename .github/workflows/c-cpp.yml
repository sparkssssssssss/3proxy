name: Cross Compile 3proxy (No-Fail Static)

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - '.github/workflows/build-3proxy.yml'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout 3proxy source
        uses: actions/checkout@v4
        with:
          repository: z3APA3A/3proxy
          ref: master
          
      - name: Install Cross-Compiler
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-mipsel-linux-gnu make
          
      - name: Disable Plugins (Brute Force)
        run: |
          # 1. 直接在当前目录及子目录查找 Makefile.Linux，去掉 plugins 依赖
          # 这样无论文件在哪都能修改，且不会因为 grep 找不到而报错
          find . -name "Makefile.Linux" -exec sed -i 's/plugins//g' {} +
          
          # 2. 查找所有的 Makefile.inc，将 PLUGINS 变量置空
          find . -name "Makefile.inc" -exec sed -i 's/^PLUGINS =.*/PLUGINS =/g' {} +
          
          echo "Makefile patching completed."

      - name: Compile 3proxy
        run: |
          # 依然在根目录执行，利用 Makefile.Linux 的递归逻辑
          # 由于上面已经修改了文件，它不会再尝试进入 plugins 目录
          
          make -f Makefile.Linux \
          CC=mipsel-linux-gnu-gcc \
          LN="mipsel-linux-gnu-gcc -static" \
          CFLAGS="-g0 -O2 -mips32r2 -mtune=mips32r2 -fomit-frame-pointer -fno-strict-aliasing -c -pthread -D_THREAD_SAFE -D_REENTRANT -DNOODBC -DWITH_STD_MALLOC -D_GNU_SOURCE -DLINUX -DWITH_POLL -DFD_SETSIZE=4096" \
          LDFLAGS="-static -s"

      - name: Locate and Check Output
        run: |
          # 编译完成后，查找生成的 3proxy 文件
          OUTPUT_PATH=$(find . -type f -name "3proxy" | head -n 1)
          
          if [ -z "$OUTPUT_PATH" ]; then
            echo "Error: Binary not found!"
            exit 1
          fi
          
          echo "Binary found at: $OUTPUT_PATH"
          ls -lh "$OUTPUT_PATH"
          file "$OUTPUT_PATH"
          
          # 移动并重命名
          mv "$OUTPUT_PATH" 3proxy_mt7621_static

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: 3proxy-mt7621-static
          path: 3proxy_mt7621_static
