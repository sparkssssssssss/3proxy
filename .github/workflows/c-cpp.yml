name: Cross Compile 3proxy (Force Static No Plugins)

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - '.github/workflows/build-3proxy.yml'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout 3proxy source
        uses: actions/checkout@v4
        with:
          repository: z3APA3A/3proxy
          ref: master
          
      - name: Install Cross-Compiler
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-mipsel-linux-gnu make
          
      - name: Compile 3proxy (Force Static)
        run: |
          cd src
          
          # --- 关键修复步骤 ---
          # 1. 修改 Makefile.inc：将 PLUGINS 变量强制设置为空
          # 这样 Makefile 就不再包含任何插件列表
          sed -i 's/^PLUGINS =.*/PLUGINS =/g' Makefile.inc

          # 2. 修改 Makefile.Linux：移除构建目标中的 "plugins" 依赖
          # 防止 make 尝试进入 plugins 目录
          sed -i 's/ plugins//g' Makefile.Linux
          
          # --- 开始编译 ---
          make -f Makefile.Linux \
          CC=mipsel-linux-gnu-gcc \
          LN="mipsel-linux-gnu-gcc -static" \
          CFLAGS="-g0 -O2 -mips32r2 -mtune=mips32r2 -fomit-frame-pointer -fno-strict-aliasing -c -pthread -D_THREAD_SAFE -D_REENTRANT -DNOODBC -DWITH_STD_MALLOC -D_GNU_SOURCE -DLINUX -DWITH_POLL -DFD_SETSIZE=4096" \
          LDFLAGS="-static -s"

      - name: Check Binary Info
        run: |
          # 检查生成结果
          ls -lh src/3proxy
          # 确认是 MIPS 架构
          file src/3proxy
          # 确认是静态链接 (不显示 uses shared libs)
          ldd src/3proxy || echo "Not a dynamic executable"

      - name: Rename Output
        run: |
          mv src/3proxy 3proxy_mt7621_static

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: 3proxy-mt7621-static
          path: 3proxy_mt7621_static
